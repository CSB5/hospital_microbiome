---
title: "Genome comparison of isolates from hospital and patient"
output:
  html_document:
    df_print: paged
---

### Genome comparison of isolates from hospital and patient

Load generic libraries
```{r message=FALSE}
source('configuration.r')
```

Load plot specific libraries
```{r message=FALSE}
library(foreach)
library(ggtree)
library(ape)
```

Function to plot tree
```{r}
get_tree_data <- function(species, filter.patient.only=TRUE, outlier=''){
  dist.dat <- read.table(paste0('../tables/',species,'_mummer_heatmap.dat'))
  meta <- read.table('../output_tables/merged_assembly_metadata.tsv', head=TRUE) %>% filter(Species==species)
  idx <- rownames(dist.dat) %in% (filter(meta, genome_quality=='HIGH_QUAL'))$genomeID |## High quality genomes
    str_detect(rownames(dist.dat), 'G_')
  dist.dat <- dist.dat[idx, idx]
  clustering.all <- hclust(as.dist(dist.dat), method='single')
  clusters.all <- cutree(clustering.all, h=0.001)
  strains <- foreach(x=unique(clusters.all), .combine=rbind) %do% {
    tmp <- clusters.all[clusters.all==x]
    dat <- data.frame(strain=tmp[order(names(tmp), decreasing = T)][1]) ## select hospital if possible
    dat$n <- length(tmp)
    dat$Hospital <- sum(str_detect(names(tmp), 's'))/dat$n
    dat$Patient <- sum(str_detect(names(tmp), 'G'))/dat$n
    dat$rep <- row.names(dat)
    dat[,c(5,1,2,3,4)]
  }
  
  ## filter patient only strains
  if(filter.patient.only) strains <- filter(strains, Patient<1)
  ## filter strains that are very different
  strains <- filter(strains, rep!=outlier) 
  strains$lab <- ifelse(strains$Hospital==1, 'Hospital', 'Hospital/Patient')
  idx <- strains$rep
  
  clustering <- hclust(as.dist(dist.dat[idx, idx]), method='single')
  
  merge(data.frame(clusters=clusters.all), meta, by.x=0, by.y=1, all.x=TRUE) %>%
     mutate(strain=paste0('s', clusters)) %>%
     mutate(lab=ifelse(str_detect(Row.names, 's'), 'Hospital', 'Patient')) -> merged
  
  mutate_at(merged, vars(Antibiotics), function(x) ifelse(merged$lab=='Patient', 'MET', as.character(x)) ) %>%
    select(clusters, Antibiotics) %>% group_by(clusters, Antibiotics) %>%
    count() %>% spread(Antibiotics,n,fill=0) %>%
    merge(x=strains, y=., by.x=2, by.y=1) %>% 
    select(-n, -strain, -BHI) %>% data.frame(row.names = 'rep') -> antibiotics
  
  select(antibiotics, AMP, CHLOR, KAN, STREP, TET) -> antibiotics
  anno <- antibiotics %>% 
    mutate_at(vars(AMP, CHLOR, KAN, STREP, TET), function(x) ifelse(x>0, 'Hospital', NA))
  rownames(anno) <- rownames(antibiotics)
  
  # ## generate barplot
  # bars <- foreach(r=1:nrow(strains)) %do% {
  #   data <- melt(strains[r,], id.vars = c('n', 'strain', 'rep')) 
  #   ggplot(data, aes(x=1, y=value, fill= variable, width=n)) +
  #     geom_bar(stat='identity', alpha=1) +
  #     coord_flip() +
  #     scale_fill_npg() +
  #     theme_inset()
  # }
  # names(bars) <- 1:length(bars)
  list(anno=anno, strains=strains, clustering=clustering)
}
```

#### *Staphylococcus aureus*

```{r fig.height=10, fig.width=10, message=FALSE}
colors <- pal_d3('category20')(20)

dat <- get_tree_data('Staphylococcus_aureus', outlier = 's_3217')
attach(dat)
## create a tree
p <- ggtree(as.phylo(clustering)) %<+%
  strains +
  geom_tippoint(aes(size=n, color=lab), shape=19) +
  geom_tiplab(aes(label=paste0('s', strain), color=lab),size=4, fontface='bold', offset=2e-4) +
  scale_size_continuous(trans='log2') + 
  scale_color_lancet() + 
  geom_treescale(x=0, y=15, width=0.001) +
  theme(legend.position="left")

## Add heatmap
tree1 <- gheatmap(p, anno, color='black', colnames_offset_y = 0.3, width=0.3, offset=0.0008, font.size=3.5,
         colnames_angle = 60, hjust =1) +
  scale_fill_manual(values=colors[3], guide=F) +
  ylim(-1, 17)

# ## Add bar plot
# tree <- inset(tree, bars, width=0.0006, height=1.4, hjust=-0.0003)
# ## Add legend for bars
# l1 <- cowplot::get_legend(bars[[1]] + theme_bw() + theme(legend.title =element_blank()))
# l2 <- cowplot::get_legend(tree)
# l <- cowplot::plot_grid(l1, l2, nrow=2)
# tree <- cowplot::plot_grid(l, tree + theme(legend.position="none"),
#           rel_widths=c(0.1,1) , nrow=1)
tree1
ggsave('../plots/fig4a.s_aureus_tree_w_patient_data.pdf', tree1, width=10, height=10)
```

#### *Elizabethkingia anophelis*

```{r fig.height=5, fig.width=10, message=FALSE}
dat <- get_tree_data('Elizabethkingia_anophelis',  outlier = 's_2815')
attach(dat)
## create a tree
p <- ggtree(as.phylo(clustering)) %<+%
  strains +
  geom_tippoint(aes(size=n, color=lab), shape=19) +
  geom_tiplab(aes(label=paste0('s', strain), color=lab),size=4, fontface='bold', offset=1.5e-3, hjust=0.5) +
  scale_size_continuous(trans='log2') + 
  scale_color_lancet() + 
  geom_treescale(x=0.05, y=5, width=0.001) +
  theme(legend.position="left")

## Add heatmap
tree2 <- gheatmap(p, anno, color='black', colnames_offset_y = 0.3, width=0.3, offset=0.002, font.size=3.5, 
                  colnames_angle = 60, hjust=1) + 
  scale_fill_manual(values=colors[8], guide=F) + 
  ylim(-1, 6.5)
  
tree2
ggsave('../plots/sup14.e_anophelis_tree_w_patient_data.pdf', tree2, width=10, height=10)
```

#### *Acinetobacter baumannii*

```{r fig.height=5, fig.width=10, message=FALSE}
dat <- get_tree_data('Acinetobacter_baumannii',  outlier = '')
attach(dat)
## create a tree
p <- ggtree(as.phylo(clustering)) %<+%
  strains +
  geom_tippoint(aes(size=n, color=lab), shape=19) +
  geom_tiplab(aes(label=paste0('s', strain), color=lab),size=4, fontface='bold', offset=-5e-4, hjust=0.5) +
  scale_size_continuous(trans='log2') + 
  scale_color_lancet() + 
  geom_treescale(x=0, y=25, width=0.001, offset=1) +
  theme(legend.position="left")

## Add heatmap
tree3 <- gheatmap(p, anno, color='black', colnames_offset_y = 0.3, width=0.3, offset=0.001, font.size=3.5,
         hjust =1) +
  scale_x_reverse() + 
  coord_flip() +
  ylim(-0.5,27) +
  scale_fill_manual(values=colors[1], guide=F)

tree3
ggsave('../plots/sup14.a_baumannii_tree_w_patient_data.pdf', tree3, width=10, height=10)
```

### *Staphylococcus epidermidis*

```{r fig.height=10, fig.width=15, message=FALSE}
dat <- get_tree_data('Staphylococcus_epidermidis', outlier = '')
attach(dat)
## create a tree
p <- ggtree(as.phylo(clustering)) %<+%
  strains +
  geom_tippoint(aes(size=n, color=lab), shape=19) +
  geom_tiplab(aes(label=paste0('s', strain), color=lab),size=4, fontface='bold', offset=-2.5e-4, hjust = 0.5) +
  scale_size_continuous(trans='log2') + 
  scale_color_lancet() + 
  geom_treescale(x=0, y=40, width=0.001, offset = 1) +
  theme(legend.position="left")

## Add heatmap
tree4 <- gheatmap(p, anno, color='black', colnames_offset_y = 0.3, width=0.5, offset=0.0004, font.size=3.5,
         hjust =1) +
  scale_x_reverse() + 
  coord_flip() +
  scale_fill_manual(values=colors[7], guide=F)

tree4
ggsave('../plots/fig4b.s_epidermidis_tree_w_patient_data.pdf', tree4, width=10, height=15)
```

```{r echo=FALSE}
bc <- cowplot::plot_grid(tree2 + theme(legend.position = 'none'),
                   tree3 + theme(legend.position = 'none'),
                   labels=c('b','c'), ncol=1, rel_heights = c(0.6,1), label_size = 30
                     )
abc <- cowplot::plot_grid(tree1 + theme(legend.position = 'none'),
                          bc,
                          labels=c('a',NULL), nrow=1,label_size = 30
                          )
abcd <- cowplot::plot_grid(abc, tree4,
                   labels=c(NA, 'd'), ncol=1,label_size = 30
                   )
ggsave('../plots/fig4.trees_w_patient.png', abcd, height=15, width = 15)
```

### Session informaton
```{r}
sessionInfo()
```