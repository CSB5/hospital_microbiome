---
title: "Potential contaminant removal"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load generic libraries
```{r message=FALSE, warning=FALSE}
source('configuration.r')
```

Load specific libraries
```{r message=FALSE, warning=FALSE}
library(readr)
library(stringr)
library(gghighlight)
library(ggrepel)
library(magrittr)
library(ComplexHeatmap)
```

### Species level analysis

```{r}
meta <- read.table('../metadata/illumina_metadata.txt', head=TRUE, row.names=2)
dat.s <- read.table('../tables/metagenomics.metaphlan2.table.s', head=TRUE, row.names=1)
dat.s[dat.s < 0.1] <- 0
dat.s <- dat.s[rowSums(dat.s)>0, ]
```

Detect taxa that are common in batch 1 and not detected in batch 2

```{r fig.height=8, fig.width=10}
batch1 <- dat.s[, filter(meta, timept %in% c(1, 2)) %>% pull(Library) ]
batch2 <- dat.s[, filter(meta, timept %in% c(3)) %>% pull(Library) ]

tmp <- cbind(
  (rowSums(batch1 > 0)/ncol(batch1)) %>% data.frame,
  (rowSums(batch2 > 0)/ncol(batch2)) %>% data.frame
) 
colnames(tmp) <- c('batch1', 'batch2')
tmp <- rownames_to_column(tmp, 'species') %>% 
  mutate(ratio=batch1/(batch2)) 
#head(tmp)

mutate(tmp, species=str_replace_all(species, c('s__'='', '_'=' '))) %>% 
  ggplot(aes(x=batch1, y=batch2, label=species)) + 
  geom_point(col='black')  + 
  gghighlight(ratio>3 & batch1>0.22) +
  geom_vline(xintercept = 1/4, color='blue', lty=2) + 
  geom_abline(slope = 1/4, intercept = 0, color='blue', lty=2) + 
  geom_point(data=subset(tmp, ratio>4 & batch1>1/4), aes(x=batch1, y=batch2), col='red', inherit.aes = F, size=3) + 
  geom_text_repel(col='black', fontface='italic') + 
  labs(x='Prevalence in batch 1', y='Prevalence in batch 2')
```

Check if the borderline species were correlated with the potential contaminants
```{r }
species.candidates <-  filter(tmp,ratio>3 & batch1>0.22) %>% pull(species)
species.removed <- filter(tmp,ratio>4 & batch1>1/4) %>% pull(species)

mat <- cor(t(batch1[species.candidates,]), method='spearman')[species.removed, ] 

rownames(mat) %<>% str_replace_all(c('s__'='', '_'=' ')) %>% str_replace('[a-z]+ ', '. ')
colnames(mat) %<>% str_replace_all(c('s__'='', '_'=' ')) %>% str_replace('[a-z]+ ', '. ')

Heatmap(mat, 
        heatmap_legend_param = list(title='', legend_height=unit(5, "cm"), labels_gp=gpar(fontsize=15)), 
        row_names_gp=gpar(fontface = "bold.italic"), column_names_gp = gpar(fontface = "bold.italic")) %>% 
  draw(heatmap_legend_side = "left")
```

```{r}
write.table(species.removed, '../output_tables/contaminant_candidates.txt', quote=F, row.names = F, col.names = F)

dat.fil <- dat.s[!rownames(dat.s) %in% species.removed, ] 

## remaining proportion
boxplot(colSums(dat.fil))
```


Renormalize to 100%

```{r}
dat.fil <- apply(dat.fil, 2, function(x) x/sum(x)) * 100
write.table(dat.fil, '../output_tables/metagenomics.metaphlan2.table.filtered.s', sep='\t', row.names = TRUE, col.names = NA, quote=F)
```

### Genus level analysis

```{r}
dat.g <- read.table('../tables/metagenomics.metaphlan2.table.g', head=TRUE, row.names=1)
```

Remove genera detected above

```{r}
genera.affected <- dat.s[rownames(dat.s) %in% species.removed, ] %>% 
  mutate(g=row.names(.)) %>% 
  mutate(g=paste0('g__', ((species.removed) %>% str_split_fixed('_',4))[,3]) %>% str_replace("g__Propionibacterium", "g__Siphoviridae_noname")) %>% 
  group_by(g) %>% 
  summarise_all(sum) %>% 
  column_to_rownames('g')

dat.fil <- dat.g
dat.fil[rownames(dat.fil) %in% rownames(genera.affected), colnames(genera.affected)] <- dat.fil[rownames(dat.fil) %in% rownames(genera.affected), colnames(genera.affected)] - genera.affected

dat.fil[dat.fil < 0.1] <- 0
dat.fil <- dat.fil[rowSums(dat.fil)>0, ]
## remaining proportion
boxplot(colSums(dat.fil))
```

Renormalize to 100%

```{r}
dat.fil <- apply(dat.fil, 2, function(x) x/sum(x)) * 100
write.table(dat.fil, '../output_tables/metagenomics.metaphlan2.table.filtered.g', sep='\t', row.names = TRUE, col.names = NA, quote=F)
```