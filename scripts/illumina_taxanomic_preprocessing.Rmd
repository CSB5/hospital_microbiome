---
title: "Potential contaminant removal"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load generic libraries
```{r message=FALSE, warning=FALSE}
source('configuration.r')
```

Load specific libraries
```{r message=FALSE, warning=FALSE}
library(readr)
```

### Genus level analysis

```{r}
meta <- read.table('../metadata/illumina_metadata.txt', head=TRUE, row.names=2)

dat <- read.table('../tables/metagenomics.metaphlan2.table.g', head=TRUE, row.names=1)
dat[dat < 0.1] <- 0
dat <- dat[rowSums(dat)>0, ]
```

Remove taxa that are detected (>=20 samples) in only one batch (time point 1 & 2 or time point 3)

```{r}
batch1 <- dat[, filter(meta, timept %in% c(1, 2)) %>% pull(Library) ]
batch2 <- dat[, filter(meta, timept %in% c(3)) %>% pull(Library) ]

fil1 <- rowSums(batch1>0) < 20 & rowSums(batch2>0) >= 20
fil2 <- rowSums(batch1>0) >= 20 & rowSums(batch2>0) < 20

dat.fil <- dat[!(fil1 | fil2), ] 

## remaining proportion
boxplot(colSums(dat.fil))
```

Renormalize to 100%

```{r}
dat.fil <- apply(dat.fil, 2, function(x) x/sum(x)) * 100
write.table(dat.fil, '../output_tables/metagenomics.metaphlan2.table.filtered.g', sep='\t', row.names = TRUE, col.names = NA, quote=F)
```

### Species level analysis

```{r}
dat.s <- read.table('../tables/metagenomics.metaphlan2.table.s', head=TRUE, row.names=1)
dat.s[dat.s < 0.1] <- 0
dat.s <- dat.s[rowSums(dat.s)>0, ]
```

Remove taxa that are detected (>=20 samples) in only one batch (time point 1 & 2 or time point 3)

```{r}
batch1 <- dat.s[, filter(meta, timept %in% c(1, 2)) %>% pull(Library) ]
batch2 <- dat.s[, filter(meta, timept %in% c(3)) %>% pull(Library) ]

fil1 <- rowSums(batch1>0) < 20 & rowSums(batch2>0) >= 20
fil2 <- rowSums(batch1>0) >= 20 & rowSums(batch2>0) < 20

dat.fil <- dat.s[!(fil1 | fil2), ] 

## remaining proportion
boxplot(colSums(dat.fil))
```


Renormalize to 100%

```{r}
dat.fil <- apply(dat.fil, 2, function(x) x/sum(x)) * 100
write.table(dat.fil, '../output_tables/metagenomics.metaphlan2.table.filtered.s', sep='\t', row.names = TRUE, col.names = NA, quote=F)
```

